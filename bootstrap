#!/bin/sh
#
# NAME
#    bootstrap -- initialize the test container environment
#
# SYNOPSIS
#    bootstrap
#
get_exposed_port() {
  if test -n "$3"
  then
    docker-compose port --index=$3 $1 $2 | cut -d: -f2
  else
    docker-compose port $1 $2 | cut -d: -f2
  fi
}

DOCKER_IP=${DOCKER_IP:-$1}
if [ -z "${DOCKER_IP}" ]
then
  if test -e /var/run/docker.sock
  then
    DOCKER_IP=127.0.0.1
  else
    docker-machine status tredis 2>/dev/null
    RESULT=$?
    if [ ${RESULT} -ne 0 ]
    then
      docker-machine create --driver virtualbox tredis
    fi
    eval $(docker-machine env tredis 2>/dev/null) || {
      echo "Failed to initialize docker environment"
      exit 2
    }
    DOCKER_IP=$(docker-machine ip tredis)
  fi
fi

test -d build || mkdir build

docker-compose stop
docker-compose rm --force
docker-compose up -d
docker-compose scale redis=2
cat > build/env-vars <<EOF
export DOCKER_IP=${DOCKER_IP}
export REDIS_HOST=${DOCKER_IP}
export REDIS_PORT=$(get_exposed_port redis 6379 1)
export REDIS2_PORT=$(get_exposed_port redis 6379 2)
export REDIS2_HOST=$(docker inspect --format '{{ .NetworkSettings.IPAddress }}' tredis_redis_2)
export REDISSLAVE_PORT=$(get_exposed_port redis-slave 6379)
export REDISSLAVE_HOST=$(docker inspect --format '{{ .NetworkSettings.IPAddress }}' tredis_redis-slave_1)
EOF
echo "Don't forget to 'source build/env-vars'"
